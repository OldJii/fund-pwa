<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#000000">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="format-detection" content="telephone=no">
  <link rel="manifest" href="/manifest.json">
  <link rel="apple-touch-icon" href="/icons/icon.svg">
  <title>åŸºé‡‘ç›¯ç›˜</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
    }
    
    input, textarea {
      -webkit-user-select: text;
      user-select: text;
    }
    
    :root {
      --bg: #000000;
      --bg-secondary: #1c1c1e;
      --bg-tertiary: #2c2c2e;
      --bg-grouped: #1c1c1e;
      --separator: rgba(84, 84, 88, 0.65);
      --label: #ffffff;
      --label-secondary: rgba(235, 235, 245, 0.6);
      --label-tertiary: rgba(235, 235, 245, 0.3);
      --tint: #0a84ff;
      --red: #ff453a;
      --green: #30d158;
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }
    
    html {
      height: 100%;
      overflow: hidden;
      touch-action: manipulation;
    }
    
    body {
      font-family: -apple-system, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', sans-serif;
      background: var(--bg);
      color: var(--label);
      height: 100%;
      overflow: hidden;
      font-size: 17px;
      line-height: 1.3;
      -webkit-font-smoothing: antialiased;
      -webkit-text-size-adjust: 100%;
      overscroll-behavior: none;
    }
    
    /* iOS å¯¼èˆªæ  */
    .navbar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 100;
      background: rgba(0, 0, 0, 0.72);
      backdrop-filter: saturate(180%) blur(20px);
      -webkit-backdrop-filter: saturate(180%) blur(20px);
      border-bottom: 0.5px solid var(--separator);
    }
    
    .navbar-content {
      height: 44px;
      margin-top: var(--safe-top);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }
    
    .navbar-title {
      font-size: 17px;
      font-weight: 600;
    }
    
    /* ä¸»å†…å®¹åŒº */
    .page-container {
      position: fixed;
      top: calc(44px + var(--safe-top));
      left: 0;
      right: 0;
      bottom: calc(49px + var(--safe-bottom));
      overflow: hidden;
    }
    
    .page {
      display: none;
      height: 100%;
      overflow-y: auto;
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior-y: contain;
    }
    
    .page.active {
      display: block;
    }
    
    .page-content {
      padding: 16px;
      padding-bottom: 32px;
    }
    
    /* iOS TabBar */
    .tabbar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 100;
      background: rgba(30, 30, 30, 0.88);
      backdrop-filter: saturate(180%) blur(20px);
      -webkit-backdrop-filter: saturate(180%) blur(20px);
      border-top: 0.5px solid var(--separator);
      padding-bottom: var(--safe-bottom);
    }
    
    .tabbar-content {
      height: 49px;
      display: flex;
    }
    
    .tab {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 2px;
      color: var(--label-secondary);
      text-decoration: none;
      transition: color 0.15s;
    }
    
    .tab.active {
      color: var(--tint);
    }
    
    .tab-icon {
      font-size: 24px;
      line-height: 1;
    }
    
    .tab-label {
      font-size: 10px;
      font-weight: 500;
    }
    
    /* iOS åˆ†ç»„åˆ—è¡¨æ ·å¼ */
    .list-section {
      background: var(--bg-grouped);
      border-radius: 10px;
      margin-bottom: 20px;
      overflow: hidden;
    }
    
    .list-header {
      font-size: 13px;
      font-weight: 400;
      color: var(--label-secondary);
      text-transform: uppercase;
      padding: 8px 16px 8px;
      letter-spacing: -0.08px;
    }
    
    .list-item {
      display: flex;
      align-items: center;
      padding: 11px 16px;
      min-height: 44px;
      background: var(--bg-secondary);
      border-bottom: 0.5px solid var(--separator);
    }
    
    .list-item:last-child {
      border-bottom: none;
    }
    
    .list-item:active {
      background: var(--bg-tertiary);
    }
    
    /* èµ„äº§å¡ç‰‡ */
    .asset-card {
      background: linear-gradient(135deg, #1a3a5c 0%, #0d1f33 100%);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .asset-label {
      font-size: 13px;
      color: var(--label-secondary);
      margin-bottom: 4px;
    }
    
    .asset-value {
      font-size: 34px;
      font-weight: 700;
      letter-spacing: 0.37px;
      margin-bottom: 12px;
      font-variant-numeric: tabular-nums;
    }
    
    .asset-row {
      display: flex;
      gap: 24px;
    }
    
    .asset-item {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    
    .asset-item-label {
      font-size: 13px;
      color: var(--label-secondary);
    }
    
    .asset-item-value {
      font-size: 17px;
      font-weight: 600;
      font-variant-numeric: tabular-nums;
    }
    
    .rise { color: var(--red); }
    .fall { color: var(--green); }
    
    /* iOS è¾“å…¥æ¡†æ ·å¼ */
    .input-group {
      background: var(--bg-secondary);
      border-radius: 10px;
      margin-bottom: 20px;
      overflow: hidden;
    }
    
    .input-row {
      display: flex;
      align-items: center;
      border-bottom: 0.5px solid var(--separator);
    }
    
    .input-row:last-child {
      border-bottom: none;
    }
    
    .input-label {
      width: 80px;
      padding: 0 16px;
      font-size: 17px;
      color: var(--label);
      flex-shrink: 0;
    }
    
    .input-field {
      flex: 1;
      min-width: 0;
      background: transparent;
      border: none;
      padding: 12px 16px 12px 0;
      font-size: 17px;
      color: var(--label);
      outline: none;
    }
    
    .input-field::placeholder {
      color: var(--label-tertiary);
    }
    
    .input-btn {
      background: var(--tint);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 8px 16px;
      font-size: 17px;
      font-weight: 500;
      margin-right: 12px;
      flex-shrink: 0;
    }
    
    .input-btn:active {
      opacity: 0.7;
    }
    
    /* åŸºé‡‘åˆ—è¡¨é¡¹ */
    .fund-row {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      background: var(--bg-secondary);
      border-bottom: 0.5px solid var(--separator);
    }
    
    .fund-row:last-child {
      border-bottom: none;
    }
    
    .fund-row:active {
      background: var(--bg-tertiary);
    }
    
    .fund-info {
      flex: 1;
      min-width: 0;
      margin-right: 12px;
    }
    
    .fund-name {
      font-size: 17px;
      font-weight: 400;
      margin-bottom: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .fund-meta {
      font-size: 13px;
      color: var(--label-secondary);
      display: flex;
      gap: 8px;
    }
    
    .fund-values {
      text-align: right;
      margin-right: 12px;
      flex-shrink: 0;
    }
    
    .fund-amount {
      font-size: 17px;
      font-variant-numeric: tabular-nums;
    }
    
    .fund-profit {
      font-size: 13px;
      font-variant-numeric: tabular-nums;
    }
    
    .fund-change {
      min-width: 70px;
      text-align: right;
      font-size: 17px;
      font-weight: 500;
      font-variant-numeric: tabular-nums;
      flex-shrink: 0;
    }
    
    .fund-delete {
      margin-left: 12px;
      color: var(--red);
      font-size: 15px;
      padding: 4px 8px;
      flex-shrink: 0;
    }
    
    /* æŒ‡æ•°ç½‘æ ¼ */
    .index-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 20px;
    }
    
    .index-card {
      background: var(--bg-secondary);
      border-radius: 10px;
      padding: 12px;
    }
    
    .index-name {
      font-size: 13px;
      color: var(--label-secondary);
      margin-bottom: 4px;
    }
    
    .index-value {
      font-size: 20px;
      font-weight: 600;
      font-variant-numeric: tabular-nums;
      margin-bottom: 2px;
    }
    
    .index-change {
      font-size: 15px;
      font-weight: 500;
      font-variant-numeric: tabular-nums;
    }
    
    /* æ¿å—åˆ—è¡¨ */
    .sector-row {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      background: var(--bg-secondary);
      border-bottom: 0.5px solid var(--separator);
    }
    
    .sector-row:last-child {
      border-bottom: none;
    }
    
    .sector-name {
      flex: 1;
      font-size: 17px;
    }
    
    .sector-flow {
      font-size: 13px;
      color: var(--label-secondary);
      margin-right: 12px;
    }
    
    .sector-change {
      min-width: 60px;
      text-align: right;
      font-size: 15px;
      font-weight: 500;
      font-variant-numeric: tabular-nums;
    }
    
    /* æ¿å—é€‰æ‹©å™¨ */
    .category-group {
      margin-bottom: 24px;
    }
    
    .category-title {
      font-size: 13px;
      color: var(--label-secondary);
      text-transform: uppercase;
      margin-bottom: 8px;
      padding-left: 4px;
    }
    
    .category-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    
    .chip {
      background: var(--bg-secondary);
      border: none;
      border-radius: 8px;
      padding: 8px 14px;
      font-size: 15px;
      color: var(--label);
    }
    
    .chip:active {
      background: var(--tint);
    }
    
    /* è¡¨æ ¼ */
    .data-table {
      width: 100%;
      font-size: 15px;
    }
    
    .data-table th,
    .data-table td {
      padding: 12px 8px;
      text-align: right;
      font-variant-numeric: tabular-nums;
    }
    
    .data-table th {
      font-weight: 500;
      color: var(--label-secondary);
      font-size: 13px;
      border-bottom: 0.5px solid var(--separator);
    }
    
    .data-table td {
      border-bottom: 0.5px solid var(--separator);
    }
    
    .data-table tr:last-child td {
      border-bottom: none;
    }
    
    .data-table th:first-child,
    .data-table td:first-child {
      text-align: left;
    }
    
    /* ä¸‹æ‹‰åˆ·æ–° */
    .pull-indicator {
      text-align: center;
      padding: 16px;
      color: var(--label-secondary);
      font-size: 13px;
      display: none;
    }
    
    .pull-indicator.visible {
      display: block;
    }
    
    .pull-indicator.loading::after {
      content: '';
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid var(--separator);
      border-top-color: var(--tint);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-left: 8px;
      vertical-align: middle;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* ç©ºçŠ¶æ€ */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
    }
    
    .empty-icon {
      font-size: 48px;
      margin-bottom: 12px;
      opacity: 0.4;
    }
    
    .empty-text {
      font-size: 15px;
      color: var(--label-secondary);
    }
    
    /* åŠ è½½çŠ¶æ€ */
    .loading-state {
      text-align: center;
      padding: 40px;
      color: var(--label-secondary);
      font-size: 15px;
    }
    
    .loading-state::after {
      content: '';
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid var(--separator);
      border-top-color: var(--tint);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-left: 8px;
      vertical-align: middle;
    }
    
    /* Toast */
    .toast {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 12px 24px;
      border-radius: 10px;
      font-size: 15px;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.2s;
      pointer-events: none;
      max-width: 80%;
      text-align: center;
    }
    
    .toast.show {
      opacity: 1;
    }
    
    /* è¿æ¶¨æ ‡ç­¾ */
    .streak-badge {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 4px;
      background: var(--bg-tertiary);
    }
    
    .streak-badge.up { color: var(--red); }
    .streak-badge.down { color: var(--green); }
  </style>
</head>
<body>
  <!-- å¯¼èˆªæ  -->
  <nav class="navbar">
    <div class="navbar-content">
      <span class="navbar-title" id="navTitle">æˆ‘çš„æŒä»“</span>
    </div>
  </nav>
  
  <!-- é¡µé¢å®¹å™¨ -->
  <div class="page-container">
    <!-- æŒä»“é¡µ -->
    <div id="page-holdings" class="page active">
      <div class="pull-indicator" id="pull-holdings">ä¸‹æ‹‰åˆ·æ–°</div>
      <div class="page-content">
        <div class="asset-card">
          <div class="asset-label">è´¦æˆ·èµ„äº§</div>
          <div class="asset-value" id="totalAsset">Â¥0.00</div>
          <div class="asset-row">
            <div class="asset-item">
              <span class="asset-item-label">å½“æ—¥æ”¶ç›Š</span>
              <span class="asset-item-value" id="dailyProfit">Â¥0.00</span>
            </div>
            <div class="asset-item">
              <span class="asset-item-label">æŒä»“æ•°é‡</span>
              <span class="asset-item-value" id="holdingNum">0åª</span>
            </div>
          </div>
        </div>
        
        <div class="input-group">
          <div class="input-row">
            <span class="input-label">ä»£ç </span>
            <input type="text" class="input-field" id="holdingCode" placeholder="6ä½åŸºé‡‘ä»£ç " maxlength="6" inputmode="numeric">
          </div>
          <div class="input-row">
            <span class="input-label">é‡‘é¢</span>
            <input type="text" class="input-field" id="holdingAmount" placeholder="æŒæœ‰é‡‘é¢" inputmode="decimal">
            <button class="input-btn" onclick="addHolding()">æ·»åŠ </button>
          </div>
        </div>
        
        <div class="list-section" id="holdingList">
          <div class="empty-state">
            <div class="empty-icon">ğŸ’°</div>
            <div class="empty-text">æš‚æ— æŒä»“</div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- è‡ªé€‰é¡µ -->
    <div id="page-watchlist" class="page">
      <div class="pull-indicator" id="pull-watchlist">ä¸‹æ‹‰åˆ·æ–°</div>
      <div class="page-content">
        <div class="input-group">
          <div class="input-row">
            <span class="input-label">ä»£ç </span>
            <input type="text" class="input-field" id="watchCode" placeholder="6ä½åŸºé‡‘ä»£ç " maxlength="6" inputmode="numeric">
            <button class="input-btn" onclick="addWatch()">æ·»åŠ </button>
          </div>
        </div>
        
        <div class="list-section" id="watchList">
          <div class="empty-state">
            <div class="empty-icon">â­</div>
            <div class="empty-text">æš‚æ— è‡ªé€‰</div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- è¡Œæƒ…é¡µ -->
    <div id="page-market" class="page">
      <div class="pull-indicator" id="pull-market">ä¸‹æ‹‰åˆ·æ–°</div>
      <div class="page-content">
        <div class="index-grid" id="indexGrid"></div>
        
        <div class="list-section">
          <div class="list-header">æˆäº¤é‡è¶‹åŠ¿</div>
          <div id="volumeTable"></div>
        </div>
      </div>
    </div>
    
    <!-- æ¿å—é¡µ -->
    <div id="page-sectors" class="page">
      <div class="pull-indicator" id="pull-sectors">ä¸‹æ‹‰åˆ·æ–°</div>
      <div class="page-content">
        <div class="list-section" id="sectorList"></div>
      </div>
    </div>
    
    <!-- æ¿å—åŸºé‡‘é¡µ -->
    <div id="page-funds" class="page">
      <div class="page-content">
        <div id="sectorChips"></div>
        <div class="list-section" id="fundsList" style="display:none;"></div>
      </div>
    </div>
  </div>
  
  <!-- TabBar -->
  <div class="tabbar">
    <div class="tabbar-content">
      <a class="tab active" data-page="holdings">
        <span class="tab-icon">ğŸ’°</span>
        <span class="tab-label">æŒä»“</span>
      </a>
      <a class="tab" data-page="watchlist">
        <span class="tab-icon">â­</span>
        <span class="tab-label">è‡ªé€‰</span>
      </a>
      <a class="tab" data-page="market">
        <span class="tab-icon">ğŸ“Š</span>
        <span class="tab-label">è¡Œæƒ…</span>
      </a>
      <a class="tab" data-page="sectors">
        <span class="tab-icon">ğŸ“ˆ</span>
        <span class="tab-label">æ¿å—</span>
      </a>
      <a class="tab" data-page="funds">
        <span class="tab-icon">ğŸ”</span>
        <span class="tab-label">åŸºé‡‘</span>
      </a>
    </div>
  </div>
  
  <div class="toast" id="toast"></div>
  
  <script>
    // ========== é…ç½® ==========
    const API = '/api';
    const TITLES = {
      holdings: 'æˆ‘çš„æŒä»“',
      watchlist: 'è‡ªé€‰åŸºé‡‘',
      market: 'å¸‚åœºè¡Œæƒ…',
      sectors: 'æ¿å—è¡Œæƒ…',
      funds: 'æ¿å—åŸºé‡‘'
    };
    
    // ========== çŠ¶æ€ ==========
    let currentPage = 'holdings';
    let holdings = {};
    let watchlist = {};
    let dataCache = {};
    let isRefreshing = {};
    
    // åˆå§‹åŒ–æ•°æ®
    try {
      holdings = JSON.parse(localStorage.getItem('holdings') || '{}');
      watchlist = JSON.parse(localStorage.getItem('watchlist') || '{}');
    } catch(e) {}
    
    // ========== å·¥å…·å‡½æ•° ==========
    function toast(msg) {
      const el = document.getElementById('toast');
      el.textContent = msg;
      el.classList.add('show');
      setTimeout(() => el.classList.remove('show'), 2000);
    }
    
    function fmt(n) {
      return n.toLocaleString('zh-CN', {minimumFractionDigits: 2, maximumFractionDigits: 2});
    }
    
    function cls(v) {
      const n = parseFloat(String(v).replace('%', ''));
      return isNaN(n) ? '' : n >= 0 ? 'rise' : 'fall';
    }
    
    function save(key, data) {
      try { localStorage.setItem(key, JSON.stringify(data)); } catch(e) {}
    }
    
    async function api(endpoint, params = {}) {
      const url = new URL(endpoint, location.origin);
      Object.entries(params).forEach(([k, v]) => url.searchParams.set(k, v));
      try {
        const res = await fetch(url);
        return await res.json();
      } catch(e) {
        return {success: false, message: 'ç½‘ç»œé”™è¯¯'};
      }
    }
    
    // ========== ä¸‹æ‹‰åˆ·æ–° ==========
    function setupPullRefresh(pageId, refreshFn) {
      const page = document.getElementById(`page-${pageId}`);
      const indicator = document.getElementById(`pull-${pageId}`);
      if (!page || !indicator) return;
      
      let startY = 0;
      let pulling = false;
      
      page.addEventListener('touchstart', e => {
        if (page.scrollTop === 0) {
          startY = e.touches[0].pageY;
          pulling = true;
        }
      }, {passive: true});
      
      page.addEventListener('touchmove', e => {
        if (!pulling) return;
        const diff = e.touches[0].pageY - startY;
        if (diff > 0 && diff < 100) {
          indicator.classList.add('visible');
          indicator.textContent = diff > 60 ? 'æ¾å¼€åˆ·æ–°' : 'ä¸‹æ‹‰åˆ·æ–°';
        }
      }, {passive: true});
      
      page.addEventListener('touchend', async e => {
        if (!pulling) return;
        pulling = false;
        const diff = e.changedTouches[0].pageY - startY;
        
        if (diff > 60 && !isRefreshing[pageId]) {
          isRefreshing[pageId] = true;
          indicator.textContent = 'åˆ·æ–°ä¸­...';
          indicator.classList.add('loading');
          
          delete dataCache[pageId];
          await refreshFn();
          
          indicator.classList.remove('loading');
          isRefreshing[pageId] = false;
        }
        
        indicator.classList.remove('visible');
      }, {passive: true});
    }
    
    // ========== é¡µé¢åˆ‡æ¢ ==========
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', e => {
        e.preventDefault();
        switchPage(tab.dataset.page);
      });
    });
    
    function switchPage(pageId) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelector(`[data-page="${pageId}"]`).classList.add('active');
      
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById(`page-${pageId}`).classList.add('active');
      
      document.getElementById('navTitle').textContent = TITLES[pageId];
      currentPage = pageId;
      
      loadPage(pageId, false);
    }
    
    async function loadPage(pageId, force = false) {
      if (!force && dataCache[pageId]) return;
      
      switch(pageId) {
        case 'holdings': await renderHoldings(); break;
        case 'watchlist': await renderWatchlist(); break;
        case 'market': await loadMarket(); break;
        case 'sectors': await loadSectors(); break;
        case 'funds': loadFundsSelector(); break;
      }
    }
    
    // ========== æŒä»“ ==========
    async function addHolding() {
      const code = document.getElementById('holdingCode').value.trim();
      const amount = parseFloat(document.getElementById('holdingAmount').value);
      
      if (!/^\d{6}$/.test(code)) {
        toast('è¯·è¾“å…¥6ä½åŸºé‡‘ä»£ç ');
        return;
      }
      if (!amount || amount <= 0) {
        toast('è¯·è¾“å…¥æœ‰æ•ˆé‡‘é¢');
        return;
      }
      
      toast('æœç´¢ä¸­...');
      const res = await api(`${API}/fund`, {action: 'search', code});
      
      if (!res.success) {
        toast(res.message || 'æœªæ‰¾åˆ°åŸºé‡‘');
        return;
      }
      
      holdings[code] = {
        code,
        name: res.fund_name,
        fund_key: res.fund_key,
        amount
      };
      save('holdings', holdings);
      
      document.getElementById('holdingCode').value = '';
      document.getElementById('holdingAmount').value = '';
      
      toast(`å·²æ·»åŠ  ${res.fund_name}`);
      delete dataCache.holdings;
      await renderHoldings();
    }
    
    function removeHolding(code) {
      if (!confirm('ç¡®å®šåˆ é™¤?')) return;
      delete holdings[code];
      save('holdings', holdings);
      delete dataCache.holdings;
      renderHoldings();
    }
    
    async function renderHoldings() {
      const list = document.getElementById('holdingList');
      const codes = Object.keys(holdings);
      
      if (!codes.length) {
        document.getElementById('totalAsset').textContent = 'Â¥0.00';
        document.getElementById('dailyProfit').textContent = 'Â¥0.00';
        document.getElementById('dailyProfit').className = 'asset-item-value';
        document.getElementById('holdingNum').textContent = '0åª';
        list.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ’°</div><div class="empty-text">æš‚æ— æŒä»“</div></div>';
        return;
      }
      
      document.getElementById('holdingNum').textContent = `${codes.length}åª`;
      
      if (!dataCache.holdings) {
        list.innerHTML = '<div class="loading-state">åŠ è½½ä¸­</div>';
        const fundsParam = codes.map(c => `${c}:${holdings[c].fund_key}`).join(',');
        const res = await api(`${API}/fund`, {action: 'batch_valuation', funds: fundsParam});
        
        if (!res.success) {
          list.innerHTML = `<div class="empty-state"><div class="empty-text">${res.message}</div></div>`;
          return;
        }
        dataCache.holdings = res.data;
      }
      
      let total = 0, profit = 0;
      let html = '';
      
      dataCache.holdings.forEach(v => {
        const h = holdings[v.code];
        if (!h) return;
        
        const pct = parseFloat(v.estimate_change) || 0;
        const p = h.amount * pct / 100;
        total += h.amount;
        profit += p;
        
        html += `
          <div class="fund-row">
            <div class="fund-info">
              <div class="fund-name">${h.name}</div>
              <div class="fund-meta"><span>${h.code}</span><span>${v.estimate_time}</span></div>
            </div>
            <div class="fund-values">
              <div class="fund-amount">Â¥${fmt(h.amount)}</div>
              <div class="fund-profit ${cls(p)}">${p >= 0 ? '+' : ''}Â¥${fmt(p)}</div>
            </div>
            <div class="fund-change ${cls(pct)}">${v.estimate_change}</div>
            <span class="fund-delete" onclick="removeHolding('${v.code}')">åˆ é™¤</span>
          </div>
        `;
      });
      
      list.innerHTML = html;
      document.getElementById('totalAsset').textContent = `Â¥${fmt(total)}`;
      document.getElementById('dailyProfit').textContent = `${profit >= 0 ? '+' : ''}Â¥${fmt(profit)}`;
      document.getElementById('dailyProfit').className = `asset-item-value ${cls(profit)}`;
    }
    
    // ========== è‡ªé€‰ ==========
    async function addWatch() {
      const code = document.getElementById('watchCode').value.trim();
      
      if (!/^\d{6}$/.test(code)) {
        toast('è¯·è¾“å…¥6ä½åŸºé‡‘ä»£ç ');
        return;
      }
      if (watchlist[code]) {
        toast('å·²åœ¨è‡ªé€‰ä¸­');
        return;
      }
      
      toast('æœç´¢ä¸­...');
      const res = await api(`${API}/fund`, {action: 'search', code});
      
      if (!res.success) {
        toast(res.message || 'æœªæ‰¾åˆ°åŸºé‡‘');
        return;
      }
      
      watchlist[code] = {
        code,
        name: res.fund_name,
        fund_key: res.fund_key
      };
      save('watchlist', watchlist);
      
      document.getElementById('watchCode').value = '';
      toast(`å·²æ·»åŠ  ${res.fund_name}`);
      delete dataCache.watchlist;
      await renderWatchlist();
    }
    
    function removeWatch(code) {
      if (!confirm('ç¡®å®šåˆ é™¤?')) return;
      delete watchlist[code];
      save('watchlist', watchlist);
      delete dataCache.watchlist;
      renderWatchlist();
    }
    
    async function renderWatchlist() {
      const list = document.getElementById('watchList');
      const codes = Object.keys(watchlist);
      
      if (!codes.length) {
        list.innerHTML = '<div class="empty-state"><div class="empty-icon">â­</div><div class="empty-text">æš‚æ— è‡ªé€‰</div></div>';
        return;
      }
      
      if (!dataCache.watchlist) {
        list.innerHTML = '<div class="loading-state">åŠ è½½ä¸­</div>';
        const fundsParam = codes.map(c => `${c}:${watchlist[c].fund_key}`).join(',');
        const res = await api(`${API}/fund`, {action: 'batch_valuation', funds: fundsParam});
        
        if (!res.success) {
          list.innerHTML = `<div class="empty-state"><div class="empty-text">${res.message}</div></div>`;
          return;
        }
        
        res.data.sort((a, b) => (parseFloat(b.estimate_change) || -999) - (parseFloat(a.estimate_change) || -999));
        dataCache.watchlist = res.data;
      }
      
      let html = '';
      dataCache.watchlist.forEach(v => {
        const w = watchlist[v.code];
        if (!w) return;
        
        const streakCls = v.streak_days >= 0 ? 'up' : 'down';
        const streakTxt = v.streak_days >= 0 ? `è¿æ¶¨${v.streak_days}å¤©` : `è¿è·Œ${Math.abs(v.streak_days)}å¤©`;
        
        html += `
          <div class="fund-row">
            <div class="fund-info">
              <div class="fund-name">${w.name}</div>
              <div class="fund-meta">
                <span>${w.code}</span>
                <span>${v.estimate_time}</span>
                <span class="streak-badge ${streakCls}">${streakTxt}</span>
              </div>
            </div>
            <div class="fund-change ${cls(v.estimate_change)}">${v.estimate_change}</div>
            <span class="fund-delete" onclick="removeWatch('${v.code}')">åˆ é™¤</span>
          </div>
        `;
      });
      
      list.innerHTML = html;
    }
    
    // ========== è¡Œæƒ… ==========
    async function loadMarket() {
      const grid = document.getElementById('indexGrid');
      const table = document.getElementById('volumeTable');
      
      if (!dataCache.market) {
        grid.innerHTML = '<div class="loading-state">åŠ è½½ä¸­</div>';
        table.innerHTML = '';
        
        const [indicesRes, volumeRes] = await Promise.all([
          api(`${API}/market`, {action: 'indices'}),
          api(`${API}/market`, {action: 'volume', days: 7})
        ]);
        
        dataCache.market = {
          indices: indicesRes.success ? indicesRes.data : [],
          volume: volumeRes.success ? volumeRes.data : []
        };
      }
      
      const {indices, volume} = dataCache.market;
      
      if (indices.length) {
        grid.innerHTML = indices.map(i => `
          <div class="index-card">
            <div class="index-name">${i.name}</div>
            <div class="index-value">${i.value}</div>
            <div class="index-change ${cls(i.change_percent)}">${i.change_percent}</div>
          </div>
        `).join('');
      } else {
        grid.innerHTML = '<div class="empty-state"><div class="empty-text">æš‚æ— æ•°æ®</div></div>';
      }
      
      if (volume.length) {
        table.innerHTML = `
          <table class="data-table">
            <thead><tr><th>æ—¥æœŸ</th><th>æ€»æˆäº¤</th><th>æ²ªå¸‚</th><th>æ·±å¸‚</th></tr></thead>
            <tbody>
              ${volume.map(v => `<tr><td>${v.date.slice(5)}</td><td>${v.total_volume}</td><td>${v.shanghai_volume}</td><td>${v.shenzhen_volume}</td></tr>`).join('')}
            </tbody>
          </table>
        `;
      }
    }
    
    // ========== æ¿å— ==========
    async function loadSectors() {
      const list = document.getElementById('sectorList');
      
      if (!dataCache.sectors) {
        list.innerHTML = '<div class="loading-state">åŠ è½½ä¸­</div>';
        const res = await api(`${API}/sector`, {action: 'performance'});
        dataCache.sectors = res.success ? res.data : [];
      }
      
      if (!dataCache.sectors.length) {
        list.innerHTML = '<div class="empty-state"><div class="empty-text">æš‚æ— æ•°æ®</div></div>';
        return;
      }
      
      list.innerHTML = dataCache.sectors.slice(0, 50).map(s => `
        <div class="sector-row">
          <div class="sector-name">${s.name}</div>
          <div class="sector-flow">ä¸»åŠ› ${s.main_flow}</div>
          <div class="sector-change ${cls(s.change_percent)}">${s.change_percent}</div>
        </div>
      `).join('');
    }
    
    // ========== æ¿å—åŸºé‡‘ ==========
    async function loadFundsSelector() {
      const container = document.getElementById('sectorChips');
      
      if (!dataCache.sectorList) {
        container.innerHTML = '<div class="loading-state">åŠ è½½ä¸­</div>';
        const res = await api(`${API}/sector`, {action: 'list'});
        dataCache.sectorList = res.success ? res.data : [];
      }
      
      container.innerHTML = dataCache.sectorList.map(cat => `
        <div class="category-group">
          <div class="category-title">${cat.category}</div>
          <div class="category-chips">
            ${cat.sectors.map(s => `<button class="chip" onclick="loadSectorFunds('${s.code}','${s.name}')">${s.name}</button>`).join('')}
          </div>
        </div>
      `).join('');
    }
    
    async function loadSectorFunds(code, name) {
      const list = document.getElementById('fundsList');
      list.style.display = 'block';
      list.innerHTML = `<div class="list-header">${name}</div><div class="loading-state">åŠ è½½ä¸­</div>`;
      
      const res = await api(`${API}/sector`, {action: 'funds', code});
      
      if (!res.success || !res.data.length) {
        list.innerHTML = `<div class="list-header">${name}</div><div class="empty-state"><div class="empty-text">æš‚æ— æ•°æ®</div></div>`;
        return;
      }
      
      list.innerHTML = `
        <div class="list-header">${name} Â· ${res.data.length}åª</div>
        ${res.data.slice(0, 50).map(f => `
          <div class="fund-row">
            <div class="fund-info">
              <div class="fund-name">${f.name}</div>
              <div class="fund-meta"><span>${f.code}</span><span>${f.type}</span></div>
            </div>
            <div class="fund-change ${cls(f.year_ytd)}">${f.year_ytd}</div>
          </div>
        `).join('')}
      `;
      
      list.scrollIntoView({behavior: 'smooth'});
    }
    
    // ========== åˆå§‹åŒ– ==========
    document.addEventListener('DOMContentLoaded', () => {
      // ç¦æ­¢åŒæŒ‡ç¼©æ”¾
      document.addEventListener('gesturestart', e => e.preventDefault());
      document.addEventListener('gesturechange', e => e.preventDefault());
      document.addEventListener('gestureend', e => e.preventDefault());
      
      // è®¾ç½®ä¸‹æ‹‰åˆ·æ–°
      setupPullRefresh('holdings', renderHoldings);
      setupPullRefresh('watchlist', renderWatchlist);
      setupPullRefresh('market', loadMarket);
      setupPullRefresh('sectors', loadSectors);
      
      // æ³¨å†Œ SW
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js').catch(() => {});
      }
      
      // åŠ è½½é¦–é¡µ
      renderHoldings();
    });
  </script>
</body>
</html>
