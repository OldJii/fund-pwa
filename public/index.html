<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#000000">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="format-detection" content="telephone=no">
  <link rel="manifest" href="/manifest.json">
  <link rel="apple-touch-icon" href="/icons/icon.svg">
  <title>åŸºé‡‘ç›¯ç›˜</title>
  <style>
    :root {
      --bg: #000000;
      --bg-elevated: #1c1c1e;
      --bg-secondary: #2c2c2e;
      --bg-tertiary: #3a3a3c;
      --fill: rgba(120, 120, 128, 0.2);
      --separator: rgba(84, 84, 88, 0.65);
      --label: #ffffff;
      --label-secondary: rgba(235, 235, 245, 0.6);
      --label-tertiary: rgba(235, 235, 245, 0.3);
      --tint: #0a84ff;
      --red: #ff453a;
      --green: #30d158;
      --orange: #ff9f0a;
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --nav-height: calc(44px + var(--safe-top));
      --tab-height: calc(49px + var(--safe-bottom));
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
    }
    
    *:not(input):not(textarea) {
      -webkit-user-select: none;
      user-select: none;
    }
    
    html, body {
      height: 100%;
      overflow: hidden;
      overscroll-behavior: none;
      touch-action: pan-y;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'SF Pro Display', sans-serif;
      font-size: 17px;
      line-height: 1.29;
      letter-spacing: -0.41px;
      background: var(--bg);
      color: var(--label);
      -webkit-font-smoothing: antialiased;
      -webkit-text-size-adjust: 100%;
    }
    
    /* ========== å¯¼èˆªæ  ========== */
    .navbar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 100;
      background: rgba(0, 0, 0, 0.85);
      -webkit-backdrop-filter: saturate(180%) blur(20px);
      backdrop-filter: saturate(180%) blur(20px);
    }
    
    .navbar::after {
      content: '';
      position: absolute;
      left: 0;
      right: 0;
      bottom: 0;
      height: 0.33px;
      background: var(--separator);
    }
    
    .navbar-inner {
      height: 44px;
      margin-top: var(--safe-top);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .navbar-title {
      font-size: 17px;
      font-weight: 600;
      letter-spacing: -0.41px;
    }
    
    /* ========== TabBar ========== */
    .tabbar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 100;
      background: rgba(30, 30, 30, 0.94);
      -webkit-backdrop-filter: saturate(180%) blur(20px);
      backdrop-filter: saturate(180%) blur(20px);
    }
    
    .tabbar::before {
      content: '';
      position: absolute;
      left: 0;
      right: 0;
      top: 0;
      height: 0.33px;
      background: var(--separator);
    }
    
    .tabbar-inner {
      height: 49px;
      display: flex;
      padding-bottom: var(--safe-bottom);
    }
    
    .tab {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 1px;
      color: var(--label-secondary);
      text-decoration: none;
      transition: color 0.2s ease;
    }
    
    .tab.active {
      color: var(--tint);
    }
    
    .tab-icon {
      font-size: 25px;
      height: 25px;
      line-height: 1;
      transition: transform 0.2s ease;
    }
    
    .tab:active .tab-icon {
      transform: scale(0.85);
    }
    
    .tab-text {
      font-size: 10px;
      font-weight: 500;
      letter-spacing: 0.06px;
    }
    
    /* ========== é¡µé¢å®¹å™¨ ========== */
    .pages {
      position: fixed;
      top: var(--nav-height);
      left: 0;
      right: 0;
      bottom: var(--tab-height);
      overflow: hidden;
    }
    
    .page {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      overflow-y: auto;
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior-y: contain;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.25s ease, visibility 0.25s ease;
    }
    
    .page.active {
      opacity: 1;
      visibility: visible;
    }
    
    .page-inner {
      padding: 16px;
      padding-bottom: 32px;
      min-height: 100%;
    }
    
    /* ========== ä¸‹æ‹‰åˆ·æ–° ========== */
    .refresh-control {
      position: absolute;
      top: -60px;
      left: 0;
      right: 0;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      pointer-events: none;
    }
    
    .refresh-spinner {
      width: 24px;
      height: 24px;
      border: 2.5px solid var(--fill);
      border-top-color: var(--label-secondary);
      border-radius: 50%;
      opacity: 0;
      transform: scale(0.5) rotate(0deg);
      transition: opacity 0.2s, transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .refresh-spinner.pulling {
      opacity: 1;
      transform: scale(1) rotate(0deg);
    }
    
    .refresh-spinner.refreshing {
      opacity: 1;
      transform: scale(1);
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* ========== å¡ç‰‡ ========== */
    .card {
      background: var(--bg-elevated);
      border-radius: 12px;
      margin-bottom: 16px;
      overflow: hidden;
    }
    
    .card-header {
      padding: 12px 16px;
      font-size: 13px;
      font-weight: 600;
      color: var(--label-secondary);
      text-transform: uppercase;
      letter-spacing: -0.08px;
    }
    
    /* ========== èµ„äº§å¡ç‰‡ ========== */
    .asset-card {
      background: linear-gradient(145deg, #1a3a5f 0%, #0d1f33 100%);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .asset-label {
      font-size: 13px;
      color: rgba(255,255,255,0.6);
      margin-bottom: 4px;
    }
    
    .asset-value {
      font-size: 34px;
      font-weight: 700;
      letter-spacing: 0.37px;
      font-variant-numeric: tabular-nums;
      margin-bottom: 16px;
    }
    
    .asset-stats {
      display: flex;
      gap: 32px;
    }
    
    .asset-stat {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    
    .asset-stat-label {
      font-size: 13px;
      color: rgba(255,255,255,0.6);
    }
    
    .asset-stat-value {
      font-size: 20px;
      font-weight: 600;
      font-variant-numeric: tabular-nums;
    }
    
    /* ========== è¾“å…¥ç»„ ========== */
    .input-card {
      background: var(--bg-elevated);
      border-radius: 12px;
      margin-bottom: 20px;
      overflow: hidden;
    }
    
    .input-row {
      display: flex;
      align-items: center;
      min-height: 44px;
      padding: 0 16px;
      border-bottom: 0.33px solid var(--separator);
    }
    
    .input-row:last-child {
      border-bottom: none;
    }
    
    .input-label {
      width: 64px;
      font-size: 17px;
      color: var(--label);
      flex-shrink: 0;
    }
    
    .input-field {
      flex: 1;
      min-width: 0;
      height: 44px;
      background: transparent;
      border: none;
      font-size: 17px;
      color: var(--label);
      outline: none;
      font-family: inherit;
      letter-spacing: -0.41px;
    }
    
    .input-field::placeholder {
      color: var(--label-tertiary);
    }
    
    .input-action {
      background: var(--tint);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 7px 14px;
      font-size: 15px;
      font-weight: 600;
      letter-spacing: -0.24px;
      margin-left: 12px;
      flex-shrink: 0;
      transition: transform 0.15s ease, opacity 0.15s ease;
    }
    
    .input-action:active {
      transform: scale(0.96);
      opacity: 0.8;
    }
    
    /* ========== åˆ—è¡¨ ========== */
    .list {
      background: var(--bg-elevated);
      border-radius: 12px;
      overflow: hidden;
    }
    
    .list-item {
      display: flex;
      align-items: center;
      min-height: 44px;
      padding: 10px 16px;
      border-bottom: 0.33px solid var(--separator);
      transition: background 0.15s ease;
    }
    
    .list-item:last-child {
      border-bottom: none;
    }
    
    .list-item:active {
      background: var(--bg-secondary);
    }
    
    .list-content {
      flex: 1;
      min-width: 0;
    }
    
    .list-title {
      font-size: 17px;
      font-weight: 400;
      letter-spacing: -0.41px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .list-subtitle {
      font-size: 13px;
      color: var(--label-secondary);
      letter-spacing: -0.08px;
      margin-top: 2px;
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    
    .list-values {
      text-align: right;
      margin: 0 12px;
      flex-shrink: 0;
    }
    
    .list-amount {
      font-size: 17px;
      font-variant-numeric: tabular-nums;
      letter-spacing: -0.41px;
    }
    
    .list-profit {
      font-size: 13px;
      font-variant-numeric: tabular-nums;
      letter-spacing: -0.08px;
      margin-top: 1px;
    }
    
    .list-accessory {
      font-size: 17px;
      font-weight: 500;
      font-variant-numeric: tabular-nums;
      letter-spacing: -0.41px;
      min-width: 72px;
      text-align: right;
      flex-shrink: 0;
    }
    
    .list-action {
      color: var(--red);
      font-size: 15px;
      font-weight: 400;
      padding: 6px 0 6px 12px;
      flex-shrink: 0;
    }
    
    /* ========== æ ‡ç­¾ ========== */
    .badge {
      font-size: 11px;
      font-weight: 500;
      padding: 2px 6px;
      border-radius: 4px;
      background: var(--bg-secondary);
    }
    
    .badge.up { color: var(--red); }
    .badge.down { color: var(--green); }
    
    /* ========== æŒ‡æ•°ç½‘æ ¼ ========== */
    .index-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 20px;
    }
    
    .index-item {
      background: var(--bg-elevated);
      border-radius: 12px;
      padding: 14px;
    }
    
    .index-name {
      font-size: 13px;
      color: var(--label-secondary);
      letter-spacing: -0.08px;
      margin-bottom: 6px;
    }
    
    .index-value {
      font-size: 22px;
      font-weight: 600;
      font-variant-numeric: tabular-nums;
      letter-spacing: 0.35px;
      margin-bottom: 2px;
    }
    
    .index-change {
      font-size: 15px;
      font-weight: 500;
      font-variant-numeric: tabular-nums;
      letter-spacing: -0.24px;
    }
    
    /* ========== æ¿å—é€‰æ‹© ========== */
    .chip-group {
      margin-bottom: 24px;
    }
    
    .chip-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--label-secondary);
      text-transform: uppercase;
      letter-spacing: -0.08px;
      margin-bottom: 10px;
    }
    
    .chip-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    
    .chip {
      background: var(--bg-elevated);
      border: none;
      border-radius: 8px;
      padding: 9px 14px;
      font-size: 15px;
      font-weight: 400;
      color: var(--label);
      letter-spacing: -0.24px;
      transition: transform 0.15s ease, background 0.15s ease;
    }
    
    .chip:active {
      transform: scale(0.96);
      background: var(--tint);
    }
    
    /* ========== è¡¨æ ¼ ========== */
    .data-table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .data-table th,
    .data-table td {
      padding: 12px 8px;
      text-align: right;
      font-variant-numeric: tabular-nums;
    }
    
    .data-table th {
      font-size: 13px;
      font-weight: 500;
      color: var(--label-secondary);
      letter-spacing: -0.08px;
      border-bottom: 0.33px solid var(--separator);
    }
    
    .data-table td {
      font-size: 15px;
      letter-spacing: -0.24px;
      border-bottom: 0.33px solid var(--separator);
    }
    
    .data-table tr:last-child td {
      border-bottom: none;
    }
    
    .data-table th:first-child,
    .data-table td:first-child {
      text-align: left;
      padding-left: 16px;
    }
    
    .data-table th:last-child,
    .data-table td:last-child {
      padding-right: 16px;
    }
    
    /* ========== çŠ¶æ€ ========== */
    .empty {
      text-align: center;
      padding: 48px 24px;
    }
    
    .empty-icon {
      font-size: 56px;
      margin-bottom: 12px;
      opacity: 0.3;
    }
    
    .empty-text {
      font-size: 15px;
      color: var(--label-secondary);
      letter-spacing: -0.24px;
    }
    
    .loading {
      text-align: center;
      padding: 32px;
    }
    
    .loading-spinner {
      width: 24px;
      height: 24px;
      border: 2.5px solid var(--fill);
      border-top-color: var(--label-secondary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto;
    }
    
    /* ========== Toast ========== */
    .toast {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.9);
      background: rgba(0, 0, 0, 0.8);
      -webkit-backdrop-filter: saturate(180%) blur(20px);
      backdrop-filter: saturate(180%) blur(20px);
      color: white;
      padding: 14px 24px;
      border-radius: 14px;
      font-size: 15px;
      font-weight: 500;
      letter-spacing: -0.24px;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      max-width: 80%;
      text-align: center;
    }
    
    .toast.show {
      opacity: 1;
      visibility: visible;
      transform: translate(-50%, -50%) scale(1);
    }
    
    /* ========== é¢œè‰² ========== */
    .rise { color: var(--red); }
    .fall { color: var(--green); }
    
    /* ========== éª¨æ¶å± ========== */
    .skeleton {
      background: linear-gradient(90deg, var(--bg-secondary) 25%, var(--bg-tertiary) 50%, var(--bg-secondary) 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
      border-radius: 4px;
    }
    
    @keyframes shimmer {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
    
    .skeleton-text {
      height: 17px;
      margin-bottom: 8px;
    }
    
    .skeleton-text.short { width: 40%; }
    .skeleton-text.medium { width: 60%; }
    .skeleton-text.long { width: 80%; }
  </style>
</head>
<body>
  <!-- å¯¼èˆªæ  -->
  <nav class="navbar">
    <div class="navbar-inner">
      <span class="navbar-title" id="navTitle">æˆ‘çš„æŒä»“</span>
    </div>
  </nav>
  
  <!-- é¡µé¢ -->
  <div class="pages">
    <!-- æŒä»“ -->
    <div id="page-holdings" class="page active" data-refresh="holdings">
      <div class="refresh-control"><div class="refresh-spinner"></div></div>
      <div class="page-inner">
        <div class="asset-card">
          <div class="asset-label">è´¦æˆ·èµ„äº§</div>
          <div class="asset-value" id="totalAsset">Â¥0.00</div>
          <div class="asset-stats">
            <div class="asset-stat">
              <span class="asset-stat-label">å½“æ—¥æ”¶ç›Š</span>
              <span class="asset-stat-value" id="dailyProfit">Â¥0.00</span>
            </div>
            <div class="asset-stat">
              <span class="asset-stat-label">æŒä»“æ•°é‡</span>
              <span class="asset-stat-value" id="holdingNum">0åª</span>
            </div>
          </div>
        </div>
        
        <div class="input-card">
          <div class="input-row">
            <span class="input-label">ä»£ç </span>
            <input type="text" class="input-field" id="holdingCode" placeholder="è¾“å…¥6ä½åŸºé‡‘ä»£ç " maxlength="6" inputmode="numeric">
          </div>
          <div class="input-row">
            <span class="input-label">é‡‘é¢</span>
            <input type="text" class="input-field" id="holdingAmount" placeholder="è¾“å…¥æŒæœ‰é‡‘é¢" inputmode="decimal">
            <button class="input-action" id="addHoldingBtn">æ·»åŠ </button>
          </div>
        </div>
        
        <div class="list" id="holdingList"></div>
      </div>
    </div>
    
    <!-- è‡ªé€‰ -->
    <div id="page-watchlist" class="page" data-refresh="watchlist">
      <div class="refresh-control"><div class="refresh-spinner"></div></div>
      <div class="page-inner">
        <div class="input-card">
          <div class="input-row">
            <span class="input-label">ä»£ç </span>
            <input type="text" class="input-field" id="watchCode" placeholder="è¾“å…¥6ä½åŸºé‡‘ä»£ç " maxlength="6" inputmode="numeric">
            <button class="input-action" id="addWatchBtn">æ·»åŠ </button>
          </div>
        </div>
        
        <div class="list" id="watchList"></div>
      </div>
    </div>
    
    <!-- è¡Œæƒ… -->
    <div id="page-market" class="page" data-refresh="market">
      <div class="refresh-control"><div class="refresh-spinner"></div></div>
      <div class="page-inner">
        <div class="index-grid" id="indexGrid"></div>
        <div class="card">
          <div class="card-header">æˆäº¤é‡è¶‹åŠ¿</div>
          <div id="volumeTable"></div>
        </div>
      </div>
    </div>
    
    <!-- æ¿å— -->
    <div id="page-sectors" class="page" data-refresh="sectors">
      <div class="refresh-control"><div class="refresh-spinner"></div></div>
      <div class="page-inner">
        <div class="list" id="sectorList"></div>
      </div>
    </div>
    
    <!-- æ¿å—åŸºé‡‘ -->
    <div id="page-funds" class="page">
      <div class="page-inner">
        <div id="chipGroups"></div>
        <div class="card" id="fundsCard" style="display:none">
          <div class="card-header" id="fundsTitle">æ¿å—åŸºé‡‘</div>
          <div id="fundsList"></div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- TabBar -->
  <div class="tabbar">
    <div class="tabbar-inner">
      <a class="tab active" data-page="holdings"><span class="tab-icon">ğŸ’°</span><span class="tab-text">æŒä»“</span></a>
      <a class="tab" data-page="watchlist"><span class="tab-icon">â­</span><span class="tab-text">è‡ªé€‰</span></a>
      <a class="tab" data-page="market"><span class="tab-icon">ğŸ“Š</span><span class="tab-text">è¡Œæƒ…</span></a>
      <a class="tab" data-page="sectors"><span class="tab-icon">ğŸ“ˆ</span><span class="tab-text">æ¿å—</span></a>
      <a class="tab" data-page="funds"><span class="tab-icon">ğŸ”</span><span class="tab-text">åŸºé‡‘</span></a>
    </div>
  </div>
  
  <div class="toast" id="toast"></div>

  <script>
    // ==================== é…ç½® ====================
    const API = '/api';
    const CACHE_TTL = 5 * 60 * 1000; // 5åˆ†é’Ÿç¼“å­˜
    const TITLES = { holdings: 'æˆ‘çš„æŒä»“', watchlist: 'è‡ªé€‰åŸºé‡‘', market: 'å¸‚åœºè¡Œæƒ…', sectors: 'æ¿å—è¡Œæƒ…', funds: 'æ¿å—åŸºé‡‘' };
    
    // ==================== çŠ¶æ€ ====================
    let currentPage = 'holdings';
    let holdings = {};
    let watchlist = {};
    let cache = {};
    let refreshing = {};
    
    // ä»æœ¬åœ°å­˜å‚¨åŠ è½½
    try {
      holdings = JSON.parse(localStorage.getItem('fund_holdings') || '{}');
      watchlist = JSON.parse(localStorage.getItem('fund_watchlist') || '{}');
      cache = JSON.parse(localStorage.getItem('fund_cache') || '{}');
      // æ¸…ç†è¿‡æœŸç¼“å­˜
      const now = Date.now();
      Object.keys(cache).forEach(k => {
        if (cache[k].ts && now - cache[k].ts > CACHE_TTL) delete cache[k];
      });
    } catch(e) {}
    
    // ==================== å·¥å…·å‡½æ•° ====================
    const $ = id => document.getElementById(id);
    const toast = msg => { const t = $('toast'); t.textContent = msg; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 2000); };
    const fmt = n => n.toLocaleString('zh-CN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    const cls = v => { const n = parseFloat(String(v).replace('%','')); return isNaN(n) ? '' : n >= 0 ? 'rise' : 'fall'; };
    const save = (k, v) => { try { localStorage.setItem(k, JSON.stringify(v)); } catch(e) {} };
    
    async function api(endpoint, params = {}) {
      const url = new URL(endpoint, location.origin);
      Object.entries(params).forEach(([k,v]) => url.searchParams.set(k, v));
      try {
        const res = await fetch(url);
        return await res.json();
      } catch(e) {
        return { success: false, message: 'ç½‘ç»œé”™è¯¯' };
      }
    }
    
    // ==================== ä¸‹æ‹‰åˆ·æ–° ====================
    function initPullRefresh() {
      document.querySelectorAll('.page[data-refresh]').forEach(page => {
        const key = page.dataset.refresh;
        const ctrl = page.querySelector('.refresh-control');
        const spinner = ctrl.querySelector('.refresh-spinner');
        
        let startY = 0, currentY = 0, pulling = false;
        
        page.addEventListener('touchstart', e => {
          if (page.scrollTop <= 0 && !refreshing[key]) {
            startY = e.touches[0].pageY;
            pulling = true;
          }
        }, { passive: true });
        
        page.addEventListener('touchmove', e => {
          if (!pulling) return;
          currentY = e.touches[0].pageY;
          const diff = Math.min(Math.max(currentY - startY, 0), 80);
          
          if (diff > 0) {
            const progress = diff / 60;
            ctrl.style.transform = `translateY(${diff}px)`;
            page.querySelector('.page-inner').style.transform = `translateY(${diff}px)`;
            spinner.classList.add('pulling');
            spinner.style.transform = `scale(${Math.min(progress, 1)}) rotate(${progress * 180}deg)`;
          }
        }, { passive: true });
        
        page.addEventListener('touchend', async () => {
          if (!pulling) return;
          pulling = false;
          
          const diff = currentY - startY;
          const inner = page.querySelector('.page-inner');
          
          if (diff >= 60 && !refreshing[key]) {
            refreshing[key] = true;
            spinner.classList.remove('pulling');
            spinner.classList.add('refreshing');
            spinner.style.transform = '';
            
            ctrl.style.transition = 'transform 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
            inner.style.transition = 'transform 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
            ctrl.style.transform = 'translateY(60px)';
            inner.style.transform = 'translateY(60px)';
            
            delete cache[key];
            await loadPageData(key, true);
            
            await new Promise(r => setTimeout(r, 300));
            
            spinner.classList.remove('refreshing');
            ctrl.style.transform = '';
            inner.style.transform = '';
            
            setTimeout(() => {
              ctrl.style.transition = '';
              inner.style.transition = '';
              refreshing[key] = false;
            }, 300);
          } else {
            ctrl.style.transition = 'transform 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
            inner.style.transition = 'transform 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
            ctrl.style.transform = '';
            inner.style.transform = '';
            spinner.classList.remove('pulling');
            spinner.style.transform = '';
            
            setTimeout(() => {
              ctrl.style.transition = '';
              inner.style.transition = '';
            }, 300);
          }
          
          startY = 0;
          currentY = 0;
        }, { passive: true });
      });
    }
    
    // ==================== é¡µé¢åˆ‡æ¢ ====================
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', e => {
        e.preventDefault();
        switchPage(tab.dataset.page);
      });
    });
    
    function switchPage(pageId) {
      if (pageId === currentPage) return;
      
      document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.page === pageId));
      document.querySelectorAll('.page').forEach(p => p.classList.toggle('active', p.id === `page-${pageId}`));
      
      $('navTitle').textContent = TITLES[pageId];
      currentPage = pageId;
      
      loadPageData(pageId);
    }
    
    async function loadPageData(pageId, force = false) {
      // æ£€æŸ¥ç¼“å­˜
      if (!force && cache[pageId] && Date.now() - cache[pageId].ts < CACHE_TTL) {
        renderPage(pageId, cache[pageId].data);
        return;
      }
      
      switch(pageId) {
        case 'holdings': await loadHoldings(force); break;
        case 'watchlist': await loadWatchlist(force); break;
        case 'market': await loadMarket(force); break;
        case 'sectors': await loadSectors(force); break;
        case 'funds': loadFundsChips(); break;
      }
    }
    
    function renderPage(pageId, data) {
      switch(pageId) {
        case 'holdings': renderHoldings(data); break;
        case 'watchlist': renderWatchlist(data); break;
        case 'market': renderMarket(data); break;
        case 'sectors': renderSectors(data); break;
      }
    }
    
    // ==================== æŒä»“ ====================
    $('addHoldingBtn').addEventListener('click', addHolding);
    
    async function addHolding() {
      const code = $('holdingCode').value.trim();
      const amount = parseFloat($('holdingAmount').value);
      
      if (!/^\d{6}$/.test(code)) return toast('è¯·è¾“å…¥6ä½åŸºé‡‘ä»£ç ');
      if (!amount || amount <= 0) return toast('è¯·è¾“å…¥æœ‰æ•ˆé‡‘é¢');
      
      toast('æœç´¢ä¸­...');
      const res = await api(`${API}/fund`, { action: 'search', code });
      if (!res.success) return toast(res.message || 'æœªæ‰¾åˆ°åŸºé‡‘');
      
      holdings[code] = { code, name: res.fund_name, fund_key: res.fund_key, amount };
      save('fund_holdings', holdings);
      
      $('holdingCode').value = '';
      $('holdingAmount').value = '';
      toast(`å·²æ·»åŠ  ${res.fund_name}`);
      
      delete cache.holdings;
      loadHoldings(true);
    }
    
    window.removeHolding = code => {
      if (!confirm('ç¡®å®šåˆ é™¤è¯¥æŒä»“?')) return;
      delete holdings[code];
      save('fund_holdings', holdings);
      delete cache.holdings;
      loadHoldings(true);
    };
    
    async function loadHoldings(force = false) {
      const list = $('holdingList');
      const codes = Object.keys(holdings);
      
      if (!codes.length) {
        $('totalAsset').textContent = 'Â¥0.00';
        $('dailyProfit').textContent = 'Â¥0.00';
        $('dailyProfit').className = 'asset-stat-value';
        $('holdingNum').textContent = '0åª';
        list.innerHTML = '<div class="empty"><div class="empty-icon">ğŸ’°</div><div class="empty-text">æš‚æ— æŒä»“ï¼Œæ·»åŠ åŸºé‡‘å¼€å§‹ç›¯ç›˜</div></div>';
        return;
      }
      
      $('holdingNum').textContent = `${codes.length}åª`;
      
      if (!force && cache.holdings && Date.now() - cache.holdings.ts < CACHE_TTL) {
        renderHoldings(cache.holdings.data);
        return;
      }
      
      list.innerHTML = '<div class="loading"><div class="loading-spinner"></div></div>';
      
      const fundsParam = codes.map(c => `${c}:${holdings[c].fund_key}`).join(',');
      const res = await api(`${API}/fund`, { action: 'batch_valuation', funds: fundsParam });
      
      if (!res.success) {
        list.innerHTML = `<div class="empty"><div class="empty-text">${res.message}</div></div>`;
        return;
      }
      
      cache.holdings = { data: res.data, ts: Date.now() };
      save('fund_cache', cache);
      renderHoldings(res.data);
    }
    
    function renderHoldings(data) {
      let total = 0, profit = 0;
      let html = '';
      
      data.forEach(v => {
        const h = holdings[v.code];
        if (!h) return;
        
        const pct = parseFloat(v.estimate_change) || 0;
        const p = h.amount * pct / 100;
        total += h.amount;
        profit += p;
        
        html += `
          <div class="list-item">
            <div class="list-content">
              <div class="list-title">${h.name}</div>
              <div class="list-subtitle"><span>${h.code}</span><span>${v.estimate_time}</span></div>
            </div>
            <div class="list-values">
              <div class="list-amount">Â¥${fmt(h.amount)}</div>
              <div class="list-profit ${cls(p)}">${p >= 0 ? '+' : ''}${fmt(p)}</div>
            </div>
            <div class="list-accessory ${cls(pct)}">${v.estimate_change}</div>
            <span class="list-action" onclick="removeHolding('${v.code}')">åˆ é™¤</span>
          </div>
        `;
      });
      
      $('holdingList').innerHTML = html;
      $('totalAsset').textContent = `Â¥${fmt(total)}`;
      $('dailyProfit').textContent = `${profit >= 0 ? '+' : ''}Â¥${fmt(profit)}`;
      $('dailyProfit').className = `asset-stat-value ${cls(profit)}`;
    }
    
    // ==================== è‡ªé€‰ ====================
    $('addWatchBtn').addEventListener('click', addWatch);
    
    async function addWatch() {
      const code = $('watchCode').value.trim();
      if (!/^\d{6}$/.test(code)) return toast('è¯·è¾“å…¥6ä½åŸºé‡‘ä»£ç ');
      if (watchlist[code]) return toast('å·²åœ¨è‡ªé€‰ä¸­');
      
      toast('æœç´¢ä¸­...');
      const res = await api(`${API}/fund`, { action: 'search', code });
      if (!res.success) return toast(res.message || 'æœªæ‰¾åˆ°åŸºé‡‘');
      
      watchlist[code] = { code, name: res.fund_name, fund_key: res.fund_key };
      save('fund_watchlist', watchlist);
      
      $('watchCode').value = '';
      toast(`å·²æ·»åŠ  ${res.fund_name}`);
      
      delete cache.watchlist;
      loadWatchlist(true);
    }
    
    window.removeWatch = code => {
      if (!confirm('ç¡®å®šåˆ é™¤?')) return;
      delete watchlist[code];
      save('fund_watchlist', watchlist);
      delete cache.watchlist;
      loadWatchlist(true);
    };
    
    async function loadWatchlist(force = false) {
      const list = $('watchList');
      const codes = Object.keys(watchlist);
      
      if (!codes.length) {
        list.innerHTML = '<div class="empty"><div class="empty-icon">â­</div><div class="empty-text">æš‚æ— è‡ªé€‰ï¼Œæ·»åŠ åŸºé‡‘å…³æ³¨è¡Œæƒ…</div></div>';
        return;
      }
      
      if (!force && cache.watchlist && Date.now() - cache.watchlist.ts < CACHE_TTL) {
        renderWatchlist(cache.watchlist.data);
        return;
      }
      
      list.innerHTML = '<div class="loading"><div class="loading-spinner"></div></div>';
      
      const fundsParam = codes.map(c => `${c}:${watchlist[c].fund_key}`).join(',');
      const res = await api(`${API}/fund`, { action: 'batch_valuation', funds: fundsParam });
      
      if (!res.success) {
        list.innerHTML = `<div class="empty"><div class="empty-text">${res.message}</div></div>`;
        return;
      }
      
      res.data.sort((a, b) => (parseFloat(b.estimate_change) || -999) - (parseFloat(a.estimate_change) || -999));
      cache.watchlist = { data: res.data, ts: Date.now() };
      save('fund_cache', cache);
      renderWatchlist(res.data);
    }
    
    function renderWatchlist(data) {
      $('watchList').innerHTML = data.map(v => {
        const w = watchlist[v.code];
        if (!w) return '';
        const streakCls = v.streak_days >= 0 ? 'up' : 'down';
        const streakTxt = v.streak_days >= 0 ? `è¿æ¶¨${v.streak_days}å¤©` : `è¿è·Œ${Math.abs(v.streak_days)}å¤©`;
        return `
          <div class="list-item">
            <div class="list-content">
              <div class="list-title">${w.name}</div>
              <div class="list-subtitle">
                <span>${w.code}</span>
                <span>${v.estimate_time}</span>
                <span class="badge ${streakCls}">${streakTxt}</span>
              </div>
            </div>
            <div class="list-accessory ${cls(v.estimate_change)}">${v.estimate_change}</div>
            <span class="list-action" onclick="removeWatch('${v.code}')">åˆ é™¤</span>
          </div>
        `;
      }).join('');
    }
    
    // ==================== è¡Œæƒ… ====================
    async function loadMarket(force = false) {
      const grid = $('indexGrid');
      const table = $('volumeTable');
      
      if (!force && cache.market && Date.now() - cache.market.ts < CACHE_TTL) {
        renderMarket(cache.market.data);
        return;
      }
      
      grid.innerHTML = '<div class="loading"><div class="loading-spinner"></div></div>';
      table.innerHTML = '';
      
      const [indicesRes, volumeRes] = await Promise.all([
        api(`${API}/market`, { action: 'indices' }),
        api(`${API}/market`, { action: 'volume', days: 7 })
      ]);
      
      const data = {
        indices: indicesRes.success ? indicesRes.data : [],
        volume: volumeRes.success ? volumeRes.data : []
      };
      
      cache.market = { data, ts: Date.now() };
      save('fund_cache', cache);
      renderMarket(data);
    }
    
    function renderMarket({ indices, volume }) {
      $('indexGrid').innerHTML = indices.length ? indices.map(i => `
        <div class="index-item">
          <div class="index-name">${i.name}</div>
          <div class="index-value">${i.value}</div>
          <div class="index-change ${cls(i.change_percent)}">${i.change_percent}</div>
        </div>
      `).join('') : '<div class="empty"><div class="empty-text">æš‚æ— æ•°æ®</div></div>';
      
      $('volumeTable').innerHTML = volume.length ? `
        <table class="data-table">
          <thead><tr><th>æ—¥æœŸ</th><th>æ€»æˆäº¤</th><th>æ²ªå¸‚</th><th>æ·±å¸‚</th></tr></thead>
          <tbody>${volume.map(v => `<tr><td>${v.date.slice(5)}</td><td>${v.total_volume}</td><td>${v.shanghai_volume}</td><td>${v.shenzhen_volume}</td></tr>`).join('')}</tbody>
        </table>
      ` : '';
    }
    
    // ==================== æ¿å— ====================
    async function loadSectors(force = false) {
      const list = $('sectorList');
      
      if (!force && cache.sectors && Date.now() - cache.sectors.ts < CACHE_TTL) {
        renderSectors(cache.sectors.data);
        return;
      }
      
      list.innerHTML = '<div class="loading"><div class="loading-spinner"></div></div>';
      
      const res = await api(`${API}/sector`, { action: 'performance' });
      const data = res.success ? res.data : [];
      
      cache.sectors = { data, ts: Date.now() };
      save('fund_cache', cache);
      renderSectors(data);
    }
    
    function renderSectors(data) {
      $('sectorList').innerHTML = data.length ? data.slice(0, 50).map(s => `
        <div class="list-item">
          <div class="list-content"><div class="list-title">${s.name}</div></div>
          <div class="list-subtitle" style="margin-right:12px;color:var(--label-secondary)">ä¸»åŠ› ${s.main_flow}</div>
          <div class="list-accessory ${cls(s.change_percent)}">${s.change_percent}</div>
        </div>
      `).join('') : '<div class="empty"><div class="empty-text">æš‚æ— æ•°æ®</div></div>';
    }
    
    // ==================== æ¿å—åŸºé‡‘ ====================
    async function loadFundsChips() {
      const container = $('chipGroups');
      
      if (cache.sectorList) {
        renderChips(cache.sectorList);
        return;
      }
      
      container.innerHTML = '<div class="loading"><div class="loading-spinner"></div></div>';
      
      const res = await api(`${API}/sector`, { action: 'list' });
      if (res.success) {
        cache.sectorList = res.data;
        save('fund_cache', cache);
        renderChips(res.data);
      }
    }
    
    function renderChips(data) {
      $('chipGroups').innerHTML = data.map(cat => `
        <div class="chip-group">
          <div class="chip-title">${cat.category}</div>
          <div class="chip-list">${cat.sectors.map(s => `<button class="chip" onclick="loadSectorFunds('${s.code}','${s.name}')">${s.name}</button>`).join('')}</div>
        </div>
      `).join('');
    }
    
    window.loadSectorFunds = async (code, name) => {
      const card = $('fundsCard');
      const list = $('fundsList');
      
      card.style.display = 'block';
      $('fundsTitle').textContent = name;
      list.innerHTML = '<div class="loading"><div class="loading-spinner"></div></div>';
      
      const res = await api(`${API}/sector`, { action: 'funds', code });
      
      if (!res.success || !res.data.length) {
        list.innerHTML = '<div class="empty"><div class="empty-text">æš‚æ— æ•°æ®</div></div>';
        return;
      }
      
      $('fundsTitle').textContent = `${name} Â· ${res.data.length}åª`;
      list.innerHTML = res.data.slice(0, 50).map(f => `
        <div class="list-item">
          <div class="list-content">
            <div class="list-title">${f.name}</div>
            <div class="list-subtitle"><span>${f.code}</span><span>${f.type}</span></div>
          </div>
          <div class="list-accessory ${cls(f.year_ytd)}">${f.year_ytd}</div>
        </div>
      `).join('');
      
      card.scrollIntoView({ behavior: 'smooth' });
    };
    
    // ==================== åˆå§‹åŒ– ====================
    document.addEventListener('DOMContentLoaded', () => {
      // ç¦æ­¢æ‰‹åŠ¿ç¼©æ”¾
      document.addEventListener('gesturestart', e => e.preventDefault());
      document.addEventListener('gesturechange', e => e.preventDefault());
      
      // åˆå§‹åŒ–ä¸‹æ‹‰åˆ·æ–°
      initPullRefresh();
      
      // æ³¨å†Œ SW
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js').catch(() => {});
      }
      
      // åŠ è½½é¦–é¡µ
      loadHoldings();
    });
  </script>
</body>
</html>
