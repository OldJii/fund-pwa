<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#0a0a0a">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="format-detection" content="telephone=no">
  <link rel="manifest" href="/manifest.json">
  <link rel="apple-touch-icon" href="/icons/icon.svg">
  <title>åŸºé‡‘ç›¯ç›˜</title>
  <style>
    :root {
      --bg: #0a0a0a;
      --bg-card: #1a1a1a;
      --bg-input: #1e1e1e;
      --border: #2a2a2a;
      --text: #ffffff;
      --text-secondary: #888888;
      --text-muted: #555555;
      --rise: #e84a50;
      --rise-bg: #e84a50;
      --fall: #2db84d;
      --fall-bg: #2db84d;
      --accent: #3478f6;
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
    }
    
    *:not(input):not(textarea) {
      -webkit-user-select: none;
      user-select: none;
    }
    
    html, body {
      height: 100%;
      overflow: hidden;
      overscroll-behavior: none;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'PingFang SC', 'Helvetica Neue', sans-serif;
      background: var(--bg);
      color: var(--text);
      font-size: 16px;
      line-height: 1.4;
      -webkit-font-smoothing: antialiased;
    }
    
    /* ========== é¡¶éƒ¨å¯¼èˆª ========== */
    .header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 100;
      background: var(--bg);
      padding-top: var(--safe-top);
    }
    
    .header-inner {
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-bottom: 1px solid var(--border);
    }
    
    .header-title {
      font-size: 17px;
      font-weight: 600;
    }
    
    /* ========== åº•éƒ¨TabBar ========== */
    .tabbar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 100;
      background: #111111;
      border-top: 1px solid var(--border);
      padding-bottom: var(--safe-bottom);
    }
    
    .tabbar-inner {
      height: 50px;
      display: flex;
    }
    
    .tab {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 2px;
      color: var(--text-muted);
      text-decoration: none;
    }
    
    .tab.active {
      color: var(--accent);
    }
    
    .tab-icon {
      font-size: 22px;
      line-height: 1;
    }
    
    .tab-text {
      font-size: 10px;
    }
    
    /* ========== é¡µé¢å®¹å™¨ ========== */
    .pages {
      position: fixed;
      top: calc(44px + var(--safe-top));
      left: 0;
      right: 0;
      bottom: calc(50px + var(--safe-bottom));
      overflow: hidden;
    }
    
    .page {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      overflow-y: auto;
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
      display: none;
    }
    
    .page.active {
      display: block;
    }
    
    /* ========== ä¸‹æ‹‰åˆ·æ–° ========== */
    .pull-hint {
      text-align: center;
      padding: 12px;
      color: var(--text-secondary);
      font-size: 13px;
      display: none;
    }
    
    .pull-hint.show {
      display: block;
    }
    
    .pull-hint.loading::after {
      content: '';
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 2px solid var(--border);
      border-top-color: var(--text-secondary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-left: 6px;
      vertical-align: middle;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* ========== è´¦æˆ·èµ„äº§åŒºåŸŸ ========== */
    .account-section {
      padding: 16px;
      border-bottom: 1px solid var(--border);
    }
    
    .account-label {
      font-size: 13px;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 8px;
    }
    
    .account-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
    }
    
    .account-total {
      font-size: 32px;
      font-weight: 500;
      font-variant-numeric: tabular-nums;
      letter-spacing: -0.5px;
    }
    
    .account-profit {
      text-align: right;
    }
    
    .account-profit-label {
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: 2px;
    }
    
    .account-profit-value {
      font-size: 22px;
      font-weight: 500;
      font-variant-numeric: tabular-nums;
    }
    
    /* ========== åˆ—è¡¨å¤´éƒ¨ ========== */
    .list-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      background: var(--bg);
    }
    
    .list-header-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    
    .list-header-icon {
      font-size: 18px;
      color: var(--text-muted);
    }
    
    .list-header-right {
      display: flex;
      align-items: center;
      gap: 24px;
      font-size: 12px;
      color: var(--text-secondary);
    }
    
    .list-header-col {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 2px;
    }
    
    .list-header-col span:first-child {
      color: var(--text-secondary);
    }
    
    .list-header-col span:last-child {
      font-size: 11px;
      color: var(--text-muted);
    }
    
    /* ========== åŸºé‡‘åˆ—è¡¨é¡¹ ========== */
    .fund-item {
      display: flex;
      align-items: center;
      padding: 14px 16px;
      border-bottom: 1px solid var(--border);
    }
    
    .fund-item:active {
      background: var(--bg-card);
    }
    
    .fund-info {
      flex: 1;
      min-width: 0;
    }
    
    .fund-name {
      font-size: 16px;
      font-weight: 400;
      color: var(--text);
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 200px;
    }
    
    .fund-meta {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 13px;
      color: var(--text-secondary);
    }
    
    .fund-meta .star {
      color: #f5a623;
      font-size: 12px;
    }
    
    .fund-profit {
      width: 90px;
      text-align: right;
      margin-right: 12px;
    }
    
    .fund-profit-value {
      font-size: 16px;
      font-weight: 400;
      font-variant-numeric: tabular-nums;
    }
    
    .fund-change {
      min-width: 72px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 500;
      font-variant-numeric: tabular-nums;
    }
    
    .fund-change.rise {
      background: var(--rise-bg);
      color: #fff;
    }
    
    .fund-change.fall {
      background: var(--fall-bg);
      color: #fff;
    }
    
    /* ========== è¾“å…¥åŒºåŸŸ ========== */
    .input-section {
      padding: 16px;
      background: var(--bg);
      border-bottom: 1px solid var(--border);
    }
    
    .input-row {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }
    
    .input-row:last-child {
      margin-bottom: 0;
    }
    
    .input-field {
      flex: 1;
      min-width: 0;
      height: 40px;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 0 12px;
      font-size: 15px;
      color: var(--text);
      outline: none;
    }
    
    .input-field::placeholder {
      color: var(--text-muted);
    }
    
    .input-btn {
      height: 40px;
      padding: 0 20px;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 6px;
      font-size: 15px;
      font-weight: 500;
      flex-shrink: 0;
    }
    
    .input-btn:active {
      opacity: 0.8;
    }
    
    /* ========== åº•éƒ¨æŒ‡æ•°æ  ========== */
    .index-bar {
      position: fixed;
      bottom: calc(50px + var(--safe-bottom));
      left: 0;
      right: 0;
      height: 36px;
      background: var(--bg);
      border-top: 1px solid var(--border);
      display: flex;
      align-items: center;
      padding: 0 16px;
      gap: 16px;
      z-index: 50;
    }
    
    .index-bar-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
    }
    
    .index-bar-name {
      color: var(--text-secondary);
    }
    
    .index-bar-value {
      font-variant-numeric: tabular-nums;
    }
    
    /* ========== æŒ‡æ•°ç½‘æ ¼ ========== */
    .index-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      padding: 16px;
    }
    
    .index-card {
      background: var(--bg-card);
      border-radius: 8px;
      padding: 14px;
    }
    
    .index-name {
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 6px;
    }
    
    .index-value {
      font-size: 20px;
      font-weight: 500;
      font-variant-numeric: tabular-nums;
      margin-bottom: 2px;
    }
    
    .index-change {
      font-size: 14px;
      font-weight: 500;
      font-variant-numeric: tabular-nums;
    }
    
    /* ========== æ¿å—åˆ—è¡¨ ========== */
    .sector-item {
      display: flex;
      align-items: center;
      padding: 14px 16px;
      border-bottom: 1px solid var(--border);
    }
    
    .sector-name {
      flex: 1;
      font-size: 15px;
    }
    
    .sector-flow {
      font-size: 13px;
      color: var(--text-secondary);
      margin-right: 12px;
      font-variant-numeric: tabular-nums;
    }
    
    .sector-change {
      min-width: 65px;
      text-align: right;
      font-size: 14px;
      font-weight: 500;
      font-variant-numeric: tabular-nums;
    }
    
    /* ========== æ¿å—é€‰æ‹© ========== */
    .chip-section {
      padding: 16px;
    }
    
    .chip-title {
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 10px;
    }
    
    .chip-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 20px;
    }
    
    .chip {
      padding: 8px 14px;
      background: var(--bg-card);
      border: none;
      border-radius: 6px;
      font-size: 14px;
      color: var(--text);
    }
    
    .chip:active {
      background: var(--accent);
    }
    
    /* ========== æˆäº¤é‡è¡¨æ ¼ ========== */
    .volume-section {
      padding: 16px;
    }
    
    .volume-title {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 12px;
    }
    
    .volume-table {
      width: 100%;
      font-size: 13px;
    }
    
    .volume-table th,
    .volume-table td {
      padding: 10px 8px;
      text-align: right;
      font-variant-numeric: tabular-nums;
    }
    
    .volume-table th {
      color: var(--text-secondary);
      font-weight: 400;
      border-bottom: 1px solid var(--border);
    }
    
    .volume-table td {
      border-bottom: 1px solid var(--border);
    }
    
    .volume-table tr:last-child td {
      border-bottom: none;
    }
    
    .volume-table th:first-child,
    .volume-table td:first-child {
      text-align: left;
    }
    
    /* ========== çŠ¶æ€ ========== */
    .empty {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-secondary);
    }
    
    .empty-icon {
      font-size: 48px;
      margin-bottom: 12px;
      opacity: 0.4;
    }
    
    .empty-text {
      font-size: 14px;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
    }
    
    .spinner {
      width: 24px;
      height: 24px;
      border: 2px solid var(--border);
      border-top-color: var(--text-secondary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto;
    }
    
    /* ========== Toast ========== */
    .toast {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.85);
      color: #fff;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s;
    }
    
    .toast.show {
      opacity: 1;
      visibility: visible;
    }
    
    /* ========== é¢œè‰² ========== */
    .rise { color: var(--rise); }
    .fall { color: var(--fall); }
    
    /* ========== åˆ é™¤æŒ‰é’® ========== */
    .delete-btn {
      color: var(--rise);
      font-size: 13px;
      padding: 4px 8px;
      margin-left: 8px;
    }
    
    /* ========== è‡ªé€‰åŸºé‡‘é¢å¤–ä¿¡æ¯ ========== */
    .fund-extra {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-right: 12px;
    }
    
    .fund-time {
      font-size: 12px;
      color: var(--text-muted);
    }
    
    .fund-streak {
      font-size: 11px;
      color: var(--text-secondary);
    }
  </style>
</head>
<body>
  <!-- é¡¶éƒ¨å¯¼èˆª -->
  <header class="header">
    <div class="header-inner">
      <span class="header-title" id="headerTitle">åŸºé‡‘ç›¯ç›˜</span>
    </div>
  </header>
  
  <!-- é¡µé¢å®¹å™¨ -->
  <div class="pages">
    <!-- æŒä»“é¡µ -->
    <div id="page-holdings" class="page active">
      <div class="pull-hint" id="pull-holdings">ä¸‹æ‹‰åˆ·æ–°</div>
      
      <!-- è´¦æˆ·èµ„äº§ -->
      <div class="account-section">
        <div class="account-label">
          <span>è´¦æˆ·èµ„äº§</span>
          <span style="font-size:16px">ğŸ‘</span>
        </div>
        <div class="account-row">
          <div class="account-total" id="totalAsset">0.00</div>
          <div class="account-profit">
            <div class="account-profit-label">å½“æ—¥æ”¶ç›Š</div>
            <div class="account-profit-value" id="dailyProfit">0.00</div>
          </div>
        </div>
      </div>
      
      <!-- è¾“å…¥åŒºåŸŸ -->
      <div class="input-section">
        <div class="input-row">
          <input type="text" class="input-field" id="holdingCode" placeholder="åŸºé‡‘ä»£ç " maxlength="6" inputmode="numeric">
          <input type="text" class="input-field" id="holdingAmount" placeholder="æŒæœ‰é‡‘é¢" inputmode="decimal">
          <button class="input-btn" onclick="addHolding()">æ·»åŠ </button>
        </div>
      </div>
      
      <!-- åˆ—è¡¨å¤´éƒ¨ -->
      <div class="list-header">
        <div class="list-header-left">
          <span class="list-header-icon">âš™ï¸</span>
          <span class="list-header-icon">ğŸ“Š</span>
          <span class="list-header-icon">ğŸ‘¤</span>
          <span class="list-header-icon">â‰¡</span>
        </div>
        <div class="list-header-right">
          <div class="list-header-col">
            <span>å½“æ—¥æ”¶ç›Š</span>
          </div>
          <div class="list-header-col">
            <span>å½“æ—¥æ¶¨å¹…</span>
          </div>
        </div>
      </div>
      
      <!-- åŸºé‡‘åˆ—è¡¨ -->
      <div id="holdingList"></div>
    </div>
    
    <!-- è‡ªé€‰é¡µ -->
    <div id="page-watchlist" class="page">
      <div class="pull-hint" id="pull-watchlist">ä¸‹æ‹‰åˆ·æ–°</div>
      
      <div class="input-section">
        <div class="input-row">
          <input type="text" class="input-field" id="watchCode" placeholder="åŸºé‡‘ä»£ç " maxlength="6" inputmode="numeric">
          <button class="input-btn" onclick="addWatch()">æ·»åŠ </button>
        </div>
      </div>
      
      <div class="list-header">
        <div class="list-header-left">
          <span style="font-size:13px;color:var(--text-secondary)">è‡ªé€‰åŸºé‡‘</span>
        </div>
        <div class="list-header-right">
          <div class="list-header-col">
            <span>ä¼°å€¼æ—¶é—´</span>
          </div>
          <div class="list-header-col">
            <span>ä¼°å€¼æ¶¨å¹…</span>
          </div>
        </div>
      </div>
      
      <div id="watchList"></div>
    </div>
    
    <!-- è¡Œæƒ…é¡µ -->
    <div id="page-market" class="page">
      <div class="pull-hint" id="pull-market">ä¸‹æ‹‰åˆ·æ–°</div>
      <div class="index-grid" id="indexGrid"></div>
      <div class="volume-section">
        <div class="volume-title">æˆäº¤é‡è¶‹åŠ¿ï¼ˆè¿‘7æ—¥ï¼‰</div>
        <div id="volumeTable"></div>
      </div>
    </div>
    
    <!-- æ¿å—é¡µ -->
    <div id="page-sectors" class="page">
      <div class="pull-hint" id="pull-sectors">ä¸‹æ‹‰åˆ·æ–°</div>
      <div id="sectorList"></div>
    </div>
    
    <!-- æ¿å—åŸºé‡‘é¡µ -->
    <div id="page-funds" class="page">
      <div class="chip-section" id="chipSection"></div>
      <div id="fundsList"></div>
    </div>
  </div>
  
  <!-- åº•éƒ¨æŒ‡æ•°æ  -->
  <div class="index-bar" id="indexBar">
    <div class="index-bar-item">
      <span class="index-bar-name">ä¸Šè¯æŒ‡æ•°</span>
      <span class="index-bar-value" id="shIndex">--</span>
      <span class="index-bar-value" id="shChange">--</span>
    </div>
  </div>
  
  <!-- TabBar -->
  <div class="tabbar">
    <div class="tabbar-inner">
      <a class="tab active" data-page="holdings"><span class="tab-icon">ğŸ’°</span><span class="tab-text">æŒä»“</span></a>
      <a class="tab" data-page="watchlist"><span class="tab-icon">â­</span><span class="tab-text">è‡ªé€‰</span></a>
      <a class="tab" data-page="market"><span class="tab-icon">ğŸ“ˆ</span><span class="tab-text">è¡Œæƒ…</span></a>
      <a class="tab" data-page="sectors"><span class="tab-icon">ğŸ“Š</span><span class="tab-text">æ¿å—</span></a>
      <a class="tab" data-page="funds"><span class="tab-icon">ğŸ”</span><span class="tab-text">åŸºé‡‘</span></a>
    </div>
  </div>
  
  <div class="toast" id="toast"></div>

  <script>
    const API = '/api';
    const CACHE_TTL = 5 * 60 * 1000;
    const TITLES = { holdings: 'æˆ‘çš„æŒä»“', watchlist: 'è‡ªé€‰åŸºé‡‘', market: 'å¸‚åœºè¡Œæƒ…', sectors: 'æ¿å—è¡Œæƒ…', funds: 'æ¿å—åŸºé‡‘' };
    
    let currentPage = 'holdings';
    let holdings = {};
    let watchlist = {};
    let cache = {};
    let refreshing = {};
    
    try {
      holdings = JSON.parse(localStorage.getItem('fund_holdings') || '{}');
      watchlist = JSON.parse(localStorage.getItem('fund_watchlist') || '{}');
      cache = JSON.parse(localStorage.getItem('fund_cache') || '{}');
      const now = Date.now();
      Object.keys(cache).forEach(k => { if (cache[k].ts && now - cache[k].ts > CACHE_TTL) delete cache[k]; });
    } catch(e) {}
    
    const $ = id => document.getElementById(id);
    const toast = msg => { const t = $('toast'); t.textContent = msg; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 2000); };
    const fmt = n => n.toLocaleString('zh-CN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    const cls = v => { const n = parseFloat(String(v).replace('%','')); return isNaN(n) ? '' : n >= 0 ? 'rise' : 'fall'; };
    const sign = v => { const n = parseFloat(String(v).replace('%','')); return isNaN(n) || n < 0 ? '' : '+'; };
    const save = (k, v) => { try { localStorage.setItem(k, JSON.stringify(v)); } catch(e) {} };
    
    async function api(endpoint, params = {}) {
      const url = new URL(endpoint, location.origin);
      Object.entries(params).forEach(([k,v]) => url.searchParams.set(k, v));
      try { return await (await fetch(url)).json(); } catch(e) { return { success: false, message: 'ç½‘ç»œé”™è¯¯' }; }
    }
    
    // ä¸‹æ‹‰åˆ·æ–°
    function initPullRefresh(pageId, loadFn) {
      const page = $(`page-${pageId}`);
      const hint = $(`pull-${pageId}`);
      if (!page || !hint) return;
      
      let startY = 0, pulling = false;
      
      page.addEventListener('touchstart', e => {
        if (page.scrollTop <= 0 && !refreshing[pageId]) { startY = e.touches[0].pageY; pulling = true; }
      }, { passive: true });
      
      page.addEventListener('touchmove', e => {
        if (!pulling) return;
        const diff = e.touches[0].pageY - startY;
        if (diff > 0 && diff < 80) {
          hint.classList.add('show');
          hint.textContent = diff > 50 ? 'æ¾å¼€åˆ·æ–°' : 'ä¸‹æ‹‰åˆ·æ–°';
        }
      }, { passive: true });
      
      page.addEventListener('touchend', async e => {
        if (!pulling) return;
        pulling = false;
        const diff = e.changedTouches[0].pageY - startY;
        
        if (diff > 50 && !refreshing[pageId]) {
          refreshing[pageId] = true;
          hint.textContent = 'åˆ·æ–°ä¸­...';
          hint.classList.add('loading');
          delete cache[pageId];
          await loadFn(true);
          hint.classList.remove('loading');
          refreshing[pageId] = false;
        }
        hint.classList.remove('show');
        startY = 0;
      }, { passive: true });
    }
    
    // é¡µé¢åˆ‡æ¢
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', e => { e.preventDefault(); switchPage(tab.dataset.page); });
    });
    
    function switchPage(pageId) {
      document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.page === pageId));
      document.querySelectorAll('.page').forEach(p => p.classList.toggle('active', p.id === `page-${pageId}`));
      $('headerTitle').textContent = TITLES[pageId];
      $('indexBar').style.display = pageId === 'holdings' ? 'flex' : 'none';
      currentPage = pageId;
      loadPage(pageId);
    }
    
    async function loadPage(pageId, force = false) {
      if (!force && cache[pageId] && Date.now() - cache[pageId].ts < CACHE_TTL) {
        renderPage(pageId, cache[pageId].data);
        return;
      }
      switch(pageId) {
        case 'holdings': await loadHoldings(force); break;
        case 'watchlist': await loadWatchlist(force); break;
        case 'market': await loadMarket(force); break;
        case 'sectors': await loadSectors(force); break;
        case 'funds': loadChips(); break;
      }
    }
    
    function renderPage(pageId, data) {
      switch(pageId) {
        case 'holdings': renderHoldings(data); break;
        case 'watchlist': renderWatchlist(data); break;
        case 'market': renderMarket(data); break;
        case 'sectors': renderSectors(data); break;
      }
    }
    
    // æŒä»“
    async function addHolding() {
      const code = $('holdingCode').value.trim();
      const amount = parseFloat($('holdingAmount').value);
      if (!/^\d{6}$/.test(code)) return toast('è¯·è¾“å…¥6ä½åŸºé‡‘ä»£ç ');
      if (!amount || amount <= 0) return toast('è¯·è¾“å…¥æœ‰æ•ˆé‡‘é¢');
      
      toast('æœç´¢ä¸­...');
      const res = await api(`${API}/fund`, { action: 'search', code });
      if (!res.success) return toast(res.message || 'æœªæ‰¾åˆ°åŸºé‡‘');
      
      holdings[code] = { code, name: res.fund_name, fund_key: res.fund_key, amount };
      save('fund_holdings', holdings);
      $('holdingCode').value = '';
      $('holdingAmount').value = '';
      toast(`å·²æ·»åŠ  ${res.fund_name}`);
      delete cache.holdings;
      loadHoldings(true);
    }
    
    window.removeHolding = code => {
      if (!confirm('ç¡®å®šåˆ é™¤?')) return;
      delete holdings[code];
      save('fund_holdings', holdings);
      delete cache.holdings;
      loadHoldings(true);
    };
    
    async function loadHoldings(force = false) {
      const list = $('holdingList');
      const codes = Object.keys(holdings);
      
      if (!codes.length) {
        $('totalAsset').textContent = '0.00';
        $('dailyProfit').textContent = '0.00';
        $('dailyProfit').className = 'account-profit-value';
        list.innerHTML = '<div class="empty"><div class="empty-icon">ğŸ’°</div><div class="empty-text">æš‚æ— æŒä»“</div></div>';
        return;
      }
      
      if (!force && cache.holdings && Date.now() - cache.holdings.ts < CACHE_TTL) {
        renderHoldings(cache.holdings.data);
        return;
      }
      
      list.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
      const fundsParam = codes.map(c => `${c}:${holdings[c].fund_key}`).join(',');
      const res = await api(`${API}/fund`, { action: 'batch_valuation', funds: fundsParam });
      
      if (!res.success) {
        list.innerHTML = `<div class="empty"><div class="empty-text">${res.message}</div></div>`;
        return;
      }
      
      cache.holdings = { data: res.data, ts: Date.now() };
      save('fund_cache', cache);
      renderHoldings(res.data);
      
      // æ›´æ–°åº•éƒ¨æŒ‡æ•°
      const marketRes = await api(`${API}/market`, { action: 'indices' });
      if (marketRes.success && marketRes.data.length) {
        const sh = marketRes.data.find(i => i.name.includes('ä¸Šè¯')) || marketRes.data[0];
        $('shIndex').textContent = sh.value;
        $('shChange').textContent = sh.change_percent;
        $('shChange').className = `index-bar-value ${cls(sh.change_percent)}`;
      }
    }
    
    function renderHoldings(data) {
      let total = 0, profit = 0;
      
      // æŒ‰æ”¶ç›Šæ’åº
      const sorted = data.map(v => {
        const h = holdings[v.code];
        if (!h) return null;
        const pct = parseFloat(v.estimate_change) || 0;
        const p = h.amount * pct / 100;
        return { ...v, holding: h, profit: p, pct };
      }).filter(Boolean).sort((a, b) => b.profit - a.profit);
      
      let html = '';
      sorted.forEach(item => {
        const { holding: h, profit: p, pct, estimate_change } = item;
        total += h.amount;
        profit += p;
        
        html += `
          <div class="fund-item">
            <div class="fund-info">
              <div class="fund-name">${h.name}</div>
              <div class="fund-meta">
                <span>Â¥ ${fmt(h.amount)}</span>
                <span class="star">â˜…</span>
              </div>
            </div>
            <div class="fund-profit">
              <div class="fund-profit-value ${cls(p)}">${sign(p)}${fmt(p)}</div>
            </div>
            <div class="fund-change ${cls(pct)}">${sign(pct)}${estimate_change}</div>
            <span class="delete-btn" onclick="removeHolding('${h.code}')">åˆ é™¤</span>
          </div>
        `;
      });
      
      $('holdingList').innerHTML = html;
      $('totalAsset').textContent = fmt(total);
      $('dailyProfit').textContent = `${sign(profit)}${fmt(profit)}`;
      $('dailyProfit').className = `account-profit-value ${cls(profit)}`;
    }
    
    // è‡ªé€‰
    async function addWatch() {
      const code = $('watchCode').value.trim();
      if (!/^\d{6}$/.test(code)) return toast('è¯·è¾“å…¥6ä½åŸºé‡‘ä»£ç ');
      if (watchlist[code]) return toast('å·²åœ¨è‡ªé€‰ä¸­');
      
      toast('æœç´¢ä¸­...');
      const res = await api(`${API}/fund`, { action: 'search', code });
      if (!res.success) return toast(res.message || 'æœªæ‰¾åˆ°åŸºé‡‘');
      
      watchlist[code] = { code, name: res.fund_name, fund_key: res.fund_key };
      save('fund_watchlist', watchlist);
      $('watchCode').value = '';
      toast(`å·²æ·»åŠ  ${res.fund_name}`);
      delete cache.watchlist;
      loadWatchlist(true);
    }
    
    window.removeWatch = code => {
      if (!confirm('ç¡®å®šåˆ é™¤?')) return;
      delete watchlist[code];
      save('fund_watchlist', watchlist);
      delete cache.watchlist;
      loadWatchlist(true);
    };
    
    async function loadWatchlist(force = false) {
      const list = $('watchList');
      const codes = Object.keys(watchlist);
      
      if (!codes.length) {
        list.innerHTML = '<div class="empty"><div class="empty-icon">â­</div><div class="empty-text">æš‚æ— è‡ªé€‰</div></div>';
        return;
      }
      
      if (!force && cache.watchlist && Date.now() - cache.watchlist.ts < CACHE_TTL) {
        renderWatchlist(cache.watchlist.data);
        return;
      }
      
      list.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
      const fundsParam = codes.map(c => `${c}:${watchlist[c].fund_key}`).join(',');
      const res = await api(`${API}/fund`, { action: 'batch_valuation', funds: fundsParam });
      
      if (!res.success) {
        list.innerHTML = `<div class="empty"><div class="empty-text">${res.message}</div></div>`;
        return;
      }
      
      res.data.sort((a, b) => (parseFloat(b.estimate_change) || -999) - (parseFloat(a.estimate_change) || -999));
      cache.watchlist = { data: res.data, ts: Date.now() };
      save('fund_cache', cache);
      renderWatchlist(res.data);
    }
    
    function renderWatchlist(data) {
      $('watchList').innerHTML = data.map(v => {
        const w = watchlist[v.code];
        if (!w) return '';
        const streakTxt = v.streak_days >= 0 ? `è¿æ¶¨${v.streak_days}å¤©` : `è¿è·Œ${Math.abs(v.streak_days)}å¤©`;
        return `
          <div class="fund-item">
            <div class="fund-info">
              <div class="fund-name">${w.name}</div>
              <div class="fund-meta">
                <span>${w.code}</span>
                <span class="star">â˜…</span>
              </div>
            </div>
            <div class="fund-extra">
              <span class="fund-time">${v.estimate_time}</span>
              <span class="fund-streak ${cls(v.streak_days)}">${streakTxt}</span>
            </div>
            <div class="fund-change ${cls(v.estimate_change)}">${sign(v.estimate_change)}${v.estimate_change}</div>
            <span class="delete-btn" onclick="removeWatch('${w.code}')">åˆ é™¤</span>
          </div>
        `;
      }).join('');
    }
    
    // è¡Œæƒ…
    async function loadMarket(force = false) {
      const grid = $('indexGrid');
      const table = $('volumeTable');
      
      if (!force && cache.market && Date.now() - cache.market.ts < CACHE_TTL) {
        renderMarket(cache.market.data);
        return;
      }
      
      grid.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
      table.innerHTML = '';
      
      const [indicesRes, volumeRes] = await Promise.all([
        api(`${API}/market`, { action: 'indices' }),
        api(`${API}/market`, { action: 'volume', days: 7 })
      ]);
      
      const data = {
        indices: indicesRes.success ? indicesRes.data : [],
        volume: volumeRes.success ? volumeRes.data : []
      };
      
      cache.market = { data, ts: Date.now() };
      save('fund_cache', cache);
      renderMarket(data);
    }
    
    function renderMarket({ indices, volume }) {
      $('indexGrid').innerHTML = indices.length ? indices.map(i => `
        <div class="index-card">
          <div class="index-name">${i.name}</div>
          <div class="index-value">${i.value}</div>
          <div class="index-change ${cls(i.change_percent)}">${i.change_percent}</div>
        </div>
      `).join('') : '<div class="empty"><div class="empty-text">æš‚æ— æ•°æ®</div></div>';
      
      $('volumeTable').innerHTML = volume.length ? `
        <table class="volume-table">
          <thead><tr><th>æ—¥æœŸ</th><th>æ€»æˆäº¤</th><th>æ²ªå¸‚</th><th>æ·±å¸‚</th></tr></thead>
          <tbody>${volume.map(v => `<tr><td>${v.date.slice(5)}</td><td>${v.total_volume}</td><td>${v.shanghai_volume}</td><td>${v.shenzhen_volume}</td></tr>`).join('')}</tbody>
        </table>
      ` : '';
    }
    
    // æ¿å—
    async function loadSectors(force = false) {
      const list = $('sectorList');
      
      if (!force && cache.sectors && Date.now() - cache.sectors.ts < CACHE_TTL) {
        renderSectors(cache.sectors.data);
        return;
      }
      
      list.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
      const res = await api(`${API}/sector`, { action: 'performance' });
      const data = res.success ? res.data : [];
      
      cache.sectors = { data, ts: Date.now() };
      save('fund_cache', cache);
      renderSectors(data);
    }
    
    function renderSectors(data) {
      $('sectorList').innerHTML = data.length ? data.slice(0, 50).map(s => `
        <div class="sector-item">
          <div class="sector-name">${s.name}</div>
          <div class="sector-flow">ä¸»åŠ› ${s.main_flow}</div>
          <div class="sector-change ${cls(s.change_percent)}">${s.change_percent}</div>
        </div>
      `).join('') : '<div class="empty"><div class="empty-text">æš‚æ— æ•°æ®</div></div>';
    }
    
    // æ¿å—åŸºé‡‘
    async function loadChips() {
      const section = $('chipSection');
      
      if (cache.sectorList) {
        renderChips(cache.sectorList);
        return;
      }
      
      section.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
      const res = await api(`${API}/sector`, { action: 'list' });
      if (res.success) {
        cache.sectorList = res.data;
        save('fund_cache', cache);
        renderChips(res.data);
      }
    }
    
    function renderChips(data) {
      $('chipSection').innerHTML = data.map(cat => `
        <div class="chip-title">${cat.category}</div>
        <div class="chip-list">${cat.sectors.map(s => `<button class="chip" onclick="loadSectorFunds('${s.code}','${s.name}')">${s.name}</button>`).join('')}</div>
      `).join('');
    }
    
    window.loadSectorFunds = async (code, name) => {
      const list = $('fundsList');
      list.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
      
      const res = await api(`${API}/sector`, { action: 'funds', code });
      
      if (!res.success || !res.data.length) {
        list.innerHTML = '<div class="empty"><div class="empty-text">æš‚æ— æ•°æ®</div></div>';
        return;
      }
      
      list.innerHTML = `
        <div class="list-header">
          <span style="font-size:14px">${name} Â· ${res.data.length}åª</span>
        </div>
        ${res.data.slice(0, 50).map(f => `
          <div class="fund-item">
            <div class="fund-info">
              <div class="fund-name">${f.name}</div>
              <div class="fund-meta"><span>${f.code}</span><span>${f.type}</span></div>
            </div>
            <div class="fund-change ${cls(f.year_ytd)}">${f.year_ytd}</div>
          </div>
        `).join('')}
      `;
      
      list.scrollIntoView({ behavior: 'smooth' });
    };
    
    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
      document.addEventListener('gesturestart', e => e.preventDefault());
      document.addEventListener('gesturechange', e => e.preventDefault());
      
      initPullRefresh('holdings', loadHoldings);
      initPullRefresh('watchlist', loadWatchlist);
      initPullRefresh('market', loadMarket);
      initPullRefresh('sectors', loadSectors);
      
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js').catch(() => {});
      }
      
      loadHoldings();
    });
  </script>
</body>
</html>
